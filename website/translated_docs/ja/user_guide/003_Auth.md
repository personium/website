---
id: 003_Auth
title: 認証/認可モデル
sidebar_label: 認証/認可モデル
---

## はじめに

本ページではPersoniumを使うにあたって重要となる認証/認可モデルについて記述します。Personiumの認証/認可モデルを最初に理解するためには以下の3つの概念を知ることが鍵となります。

1. セル中心の認証/認可
1. RBAC (Role Based Access Control)
1. アプリ認証/認可

順に説明していきます。

-------------------------------------------------------------------------------

## セル中心の認証/認可

### データアクセスの想定

セル中心の認証/認可を説明するにあたって、パーソナルデータにアクセスする場面を想定します。次の図はPDS以前とPDSでのデータアクセスする場面を比較して表しています。

![before-after](assets/auth/before-after.png)

PDSでデータアクセスを行う場合、次のロールが登場します。

|ロール名|説明|
|-------|----|
|データ主体|データの持ち主。上記の図ではAlice, Bob, Carolを指す。|
|データアクセサー|データアクセスを行う者。データ主体だけでなく、データ主体以外がアクセスする場合も含む。|
|アプリ|データアクセサーが使用して、自身の代わりにデータアクセスを行うアプリケーション。|
|認可サーバ|データアクセスの認可を行うサーバ。|
|PDS|データ主体単位にデータを格納したサーバ。|

上図の通り、データアクセサーは通常アプリを通じてPDSにデータアクセスを行い、PDS内の認可サーバによってアクセス制御されます。

Personiumはこれまでの図左のようなサービス中心の認証/認可モデルではなく、図右のようなデータ主体(主に個人)を中心とした認証/認可モデルを採用しています。

そのため、Personiumではセルという単位でデータ主体を表し、それぞれのセルが独立したURLを持ち、かつ認証/認可機構を保持しています。具体的には各セルでは認可のフレームワークであるOAuth2の2つのエンドポイント(AuthzとToken)をセルごとに保持しています。次の表はデータ主体ごとの具体的なURLの例を表しています。

|データ主体|セルURL|OAuth2 認可エンドポイント|OAuth2 トークンエンドポイント|
|----|----|----|----|
|Alice|https://alice.example/|https://alice.example/__authz|https://alice.example/__token|
|Bob|https://bob.example/|https://bob.example/__authz|https://bob.example/__token|
|Carol|https://carol.example/|https://carol.example/__authz|https://carol.example/__token|

データのアクセスを行うときはこれらのエンドポイントを使って認可が行われた上、適切なデータアクセサーのみアクセスできるように制御されます。

### 自身セルへのデータアクセス

データアクセスを考えるのにあたって、まずはアプリを通さずにシンプルにセルに直接アクセスする場合を考えます。

データ主体であるAliceがセル内の自身のデータにアクセスする場合、以下の順序で行います。

1. Aliceセルのトークンエンドポイントに対して認証、アクセストークンを取得
2. Aliceセル内のデータに対してアクセストークンと共にアクセス

![Access owner's data](assets/auth/access_owner_data.png)

トークンエンドポイントで認証を行うときは事前に作成したデータ主体自身を表すAccount(例えばme)とパスワードを使って行います。 [^1] また、このとき事前に設定したAccountとリンクされたRoleによってデータにアクセスされます。

Roleはデータアクセス制御に使われるもので、RBACの項で詳細が説明されます。

この方法で取得したアクセストークンのアクセス範囲はAlice自身のセル内となります。

[^1]: Personium外部の認証サービスも利用可能です。将来的にはパスワード以外の認証方法にも対応を予定しています。

### 他者セルへのデータアクセス

次にAliceがBobのデータをアクセスするような他者セルへのデータアクセスを考えます。このアクセス方法では事前に以下を行います。

- BobセルのExtCellにAliceセルを追加し、Bobから見たAliceのRoleをリンクする

データアクセスするときは以下の順で行います。

1. Aliceセルのトークンエンドポイントに対して発行ターゲットのパラメータ(p_target)をBobセルに設定して認証、トランスセルトークンを取得
2. Bobセル内のデータに対してトランスセルトークンと共にアクセス

![Access other owner's data](assets/auth/access_other_data.png)

Personiumではセル間の信頼関係によってデータアクセスの制御を行います。事前にデータアクセスされるBob側のセルでExtCellにAliceセルを設定し、RoleをリンクすることでそのRoleでデータアクセスされます。上記の図ではExtCellのAliceセルとFriendというRoleをリンクしているのでFriendとしてアクセスされます。

この方法で取得したトランスセルトークンのアクセス範囲はBobのセル内となります。

### トークン交換による他者セルへのデータアクセス

他者セルへのデータアクセスはトークン交換によるもう1つの方法があります。

前述のトランスセルトークンはSAML2 Assertionに従った検証を行うため、トークン長が長くなります。そのため、クライアント-サーバ間の通信や、サーバサイドでの検証処理によってパフォーマンスが悪くなる傾向があります。トークン交換を行うことでパフォーマンス向上を見込むことができます。

トークン交換はトランスセルトークン取得の手順に1手順を追加したもので、それ以外は同じものとなります。

トークン交換では事前に以下を行います。

- BobセルのExtCellにAliceセルを追加し、Bobから見たAliceのRoleをリンクする

トークン交換は以下の順で行います。

1. Aliceセルのトークンエンドポイントに対して発行ターゲットのパラメータ(p_target)をBobセルに設定して認証、トランスセルトークンを取得
2. Bobセル内のトークンエンドポイントに対してトランスセルトークンと共に認証、Bobセル内のアクセストークンを取得
3. Bobセル内のデータに対してアクセストークンと共にアクセス

![Access other owner's data by token exchange](assets/auth/access_other_data_by_exchange.png)

アクセスするRoleやアクセス範囲はトランスセルトークンと同じです。

### トークンの更新

アクセストークンやトランスセルトークンを取得する際、アクセストークンの有効期限を更新するためのリフレッシュトークンが発行されます。

リフレッシュトークンを使ってアクセストークンを更新するときは以下の順で行います。

1. Aliceセルのトークンエンドポイントに対して認証、アクセストークンとリフレッシュトークンを取得
2. Aliceセル内のトークンエンドポイントに対してgrant_type=refresh_tokenのパラメータとリフレッシュトークンを送信

![Refresh Access token](assets/auth/refresh.png)

### 管理用トークン

これまでデータ主体のセルとセル内アカウントがあることを前提としてデータアクセス方法を述べましたが、Personiumのユニットを構築直後はセルが1つも存在せず、それを作る必要があります。また、ユニットを運用する上ではセルをデータ主体でない運用者が操作を行う必要もでてきます。

これらを行うための管理用トークンとして`ユニットマスタートークン`と`ユニットユーザトークン`が用意されています。

詳細は[ユニットユーザ](../unit-administrator/Unit-User)を参照してください。

### トークン種類

これまでデータアクセスを行うために数々のトークンが登場しました。まとめると以下の表の通りとなります。

|トークン種類|説明|有効期限|
|----|----|----|
|セルローカルトークン|トークンを発行したセルで有効なアクセストークン|1時間|
|トランスセルトークン|発行されたセルによって指定されたターゲットセルで有効なアクセストークン|1時間|
|リフレッシュトークン|既に発行されたトークンをリフレッシュするために使用されるトークン|24時間|
|ユニットマスタートークン|ユニット構築直後のセル作成などの初期設定、開発やテスト時に使う管理用トークン|-|
|ユニットユーザトークン|セル作成などの運用に使う管理用トークン|-|

-------------------------------------------------------------------------------

## RBAC (Role Based Access Control)

前項では認証したセル内のAccountやセル同士の関係によってRoleが決定されることを述べました。PersoniumはこのRoleによってデータアクセスをどこまで許可するかを制御するRBAC (Role Based Access Control)の仕組みを備えています。

TODO: 図を書く

詳細は[アクセス制御モデル](../apiref/006_Access_Control.html)の項を参照してください。

-------------------------------------------------------------------------------

## アプリ認証/認可

これまで単純化のためにアプリを通さないデータアクセス方法について記述しました。しかし、実際にデータアクセサーがデータにアクセスする場合、直接セルにアクセスすることは基本的になく、アプリにデータアクセスを移譲して行います。

また、PDS上のデータが活用されていくためには以下のアプリが豊富にあることが必要になります。

- データを提供するアプリ
- データを利用するアプリ

そのためには、1事業者だけでなく他の事業者がアプリを開発・提供できるようなオープンAPIの活用が必要になります。本項ではこのような想定の元でのアプリの認証/認可の概略について記述します。

[アプリ認証](../app-developer/app_authn.html)の項においても詳細を記述しています。

### PDSにおけるOAuth

様々な提供形態を取るアプリに安全にデータアクセスを行わせるためには適切な権限移譲を行う必要があります。
Personiumではアプリの認可・権限移譲のフレームワークであるOAuthを採用してこれらを実現しています。

先に記述した通り、PDSであるPersoniumは各データ主体のセルで認可サーバの機能を備えております。この場合のOAuthの登場人物に当てはめると以下の図の通りとなります。

![OAuth in PDS](assets/auth/pds_oauth.png)

具体的な認可のフローはgrant_typeによって異なり、Personiumでは以下のgrant_typeに対応しております。

- ROPC (Resource Owner Password Credential) フロー
- 認可コードフロー
- インプリシットフロー

grant_typeはアプリの形態(信用できるアプリかどうか、サーバーサイドWebアプリかネイティブアプリかなど)によって選択します。選択の基準として以下を推奨します。

|grant_type|採用基準|
|----------|-------|
|ROPCフロー|PDS事業者とアプリ提供者が同じである場合など、アプリの信頼性が高い場合に使用できる場合に採用。|
|認可コードフロー|PDS事業者と異なるアプリ提供者が利用する場合に採用。ネイティブアプリの場合、今後機能追加予定のPKCE併用を推奨。|
|インプリシットフロー|基本非推奨。|

次に主に使用するROPCと認可コードフローを説明します。

### ROPC (Resource Owner Password Credential) フロー

![ROPC Flow](assets/auth/ROPC.png)

本フローはアプリ上でusername/passwordを入力してアクセストークンを取得するというシンプルなフローです。

PDS事業者とアプリ提供者が同じである場合など、アプリの信頼性が高い場合に使用できるフローです。そうでない場合は次の認可コードフローを採用します。

### 認可コードフロー

認可コードフローでは、PDS上の画面でデータアクセス同意・username/passwordを入力した後、短命な認可コードをアプリ側で一旦受け取り、アプリからPDSに認可コードを送ってアクセストークンを取得するフローです。

![Authorization Code Flow](assets/auth/personium-authz-code-flow/personium-authz-code-flow.png)

[アプリ認証](../app-developer/app_authn.html)の項で詳細を記述しています。

### Boxの保護

準備中
